version: '3.8'

services:
  # –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ RSA –∫–ª—é—á–µ–π (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)
  key_generator:
    image: python:3.11-slim
    container_name: key_generator
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        echo 'üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π...' &&
        pip install --quiet cryptography &&
        echo '‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã' &&
        echo 'üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è RSA –∫–ª—é—á–µ–π...' &&
        if [ ! -f .env ]; then
          echo '‚ö†Ô∏è  .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!' &&
          echo '   –°–æ–∑–¥–∞–µ–º .env –∏–∑ .env.example...' &&
          cp .env.example .env &&
          echo '‚úÖ .env —Å–æ–∑–¥–∞–Ω –∏–∑ –ø—Ä–∏–º–µ—Ä–∞' &&
          echo '‚ÑπÔ∏è  –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏'
        fi &&
        python generate_keys.py &&
        echo '‚úÖ –ö–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'
      "
    networks:
      - restaurant-network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 30s
      timeout: 10s
      retries: 3

  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Auth Service
  postgres_auth:
    image: postgres:15-alpine
    container_name: postgres_auth
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_AUTH:-auth_pass}
      POSTGRES_DB: auth_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U auth_user -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Menu Service
  postgres_menu:
    image: postgres:15-alpine
    container_name: postgres_menu
    environment:
      POSTGRES_USER: menu_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_MENU:-menu_pass}
      POSTGRES_DB: menu_db
    ports:
      - "5433:5432"
    volumes:
      - postgres_menu_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U menu_user -d menu_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Reservation Service
  postgres_reservation:
    image: postgres:15-alpine
    container_name: postgres_reservation
    environment:
      POSTGRES_USER: res_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_RESERVATION:-res_pass}
      POSTGRES_DB: res_db
    ports:
      - "5434:5432"
    volumes:
      - postgres_reservation_data:/var/lib/postgresql/data
    networks:
      - restaurant-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U res_user -d res_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  auth_service:
    build: ./auth_service
    container_name: auth_service
    depends_on:
      key_generator:
        condition: service_completed_successfully  # –ñ–¥–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π
      postgres_auth:
        condition: service_healthy
      kafka:
        condition: service_started
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://auth_user:${POSTGRES_PASSWORD_AUTH:-auth_pass}@postgres_auth:5432/auth_db
      KAFKA_BROKER: ${KAFKA_BROKER:-kafka:9092}
      JWT_PRIVATE_KEY_PATH: /app/private_key.pem
      JWT_PUBLIC_KEY_PATH: /app/public_key.pem
      JWT_ALGORITHM: ${JWT_ALGORITHM:-RS256}
      JWT_SECRET: ${JWT_SECRET:-change_this_secret}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-120}
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL:-admin@restaurant.com}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD:-Admin123!}
    ports:
      - "8000:8000"
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º RSA –∫–ª—é—á–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      - ./private_key.pem:/app/private_key.pem
      - ./public_key.pem:/app/public_key.pem
    networks:
      - restaurant-network
    command: >
      sh -c "
        echo 'üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ RSA –∫–ª—é—á–µ–π...' &&
        if [ ! -f /app/private_key.pem ]; then
          echo '‚ùå –û—à–∏–±–∫–∞: private_key.pem –Ω–µ –Ω–∞–π–¥–µ–Ω!' &&
          echo '   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python generate_keys.py' &&
          exit 1
        fi &&
        sleep 15 &&
        uvicorn main:app --host 0.0.0.0 --port 8000
      "

  menu_service:
    build: ./menu_service
    container_name: menu_service
    depends_on:
      key_generator:
        condition: service_completed_successfully
      postgres_menu:
        condition: service_healthy
      kafka:
        condition: service_started
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://menu_user:${POSTGRES_PASSWORD_MENU:-menu_pass}@postgres_menu:5432/menu_db
      KAFKA_BROKER: ${KAFKA_BROKER:-kafka:9092}
      JWT_PUBLIC_KEY_PATH: /app/public_key.pem
      JWT_ALGORITHM: ${JWT_ALGORITHM:-RS256}
      JWT_SECRET: ${JWT_SECRET:-change_this_secret}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth_service:8000}
    ports:
      - "8001:8000"
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
      - ./public_key.pem:/app/public_key.pem
    networks:
      - restaurant-network
    command: >
      sh -c "
        echo 'üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞...' &&
        if [ ! -f /app/public_key.pem ]; then
          echo '‚ùå –û—à–∏–±–∫–∞: public_key.pem –Ω–µ –Ω–∞–π–¥–µ–Ω!' &&
          echo '   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python generate_keys.py' &&
          exit 1
        fi &&
        sleep 20 &&
        uvicorn main:app --host 0.0.0.0 --port 8000
      "

  reservation_service:
    build: ./reservation_service
    container_name: reservation_service
    depends_on:
      key_generator:
        condition: service_completed_successfully
      postgres_reservation:
        condition: service_healthy
      kafka:
        condition: service_started
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://res_user:${POSTGRES_PASSWORD_RESERVATION:-res_pass}@postgres_reservation:5432/res_db
      KAFKA_BROKER: ${KAFKA_BROKER:-kafka:9092}
      JWT_PUBLIC_KEY_PATH: /app/public_key.pem
      JWT_ALGORITHM: ${JWT_ALGORITHM:-RS256}
      JWT_SECRET: ${JWT_SECRET:-change_this_secret}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://auth_service:8000}
      MENU_SERVICE_URL: ${MENU_SERVICE_URL:-http://menu_service:8001}
    ports:
      - "8002:8000"
    volumes:
      # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
      - ./public_key.pem:/app/public_key.pem
    networks:
      - restaurant-network
    command: >
      sh -c "
        echo 'üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞...' &&
        if [ ! -f /app/public_key.pem ]; then
          echo '‚ùå –û—à–∏–±–∫–∞: public_key.pem –Ω–µ –Ω–∞–π–¥–µ–Ω!' &&
          echo '   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python generate_keys.py' &&
          exit 1
        fi &&
        sleep 25 &&
        uvicorn main:app --host 0.0.0.0 --port 8000
      "

  # –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∫–æ–Ω—Å—å—é–º–µ—Ä Kafka)
  notification_service:
    build: ./notification_service
    container_name: notification_service
    depends_on:
      key_generator:
        condition: service_completed_successfully
      kafka:
        condition: service_started
    env_file:
      - .env
    environment:
      KAFKA_BROKER: ${KAFKA_BROKER:-kafka:9092}
      SMTP_SERVER: ${SMTP_SERVER:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      FROM_EMAIL: ${FROM_EMAIL:-${SMTP_USERNAME}}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@restaurant.com}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    networks:
      - restaurant-network
    command: >
      sh -c "sleep 30 && python notification_consumer.py"

  # –°–æ–∑–¥–∞–µ–º —Ç–æ–ø–∏–∫–∏ Kafka –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è)
  kafka-init:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka_init
    depends_on:
      key_generator:
        condition: service_completed_successfully
      kafka:
        condition: service_started
    environment:
      KAFKA_BROKER: ${KAFKA_BROKER:-kafka:9092}
    command: >
      bash -c "
        echo '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ Kafka...' &&
        sleep 30 &&
        echo 'üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ø–∏–∫–æ–≤ Kafka...' &&
        # –°–æ–∑–¥–∞–µ–º —Ç–æ–ø–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        for topic in user.events menu.events reservation.events notifications; do
          echo '   –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ø–∏–∫–∞: $$topic' &&
          kafka-topics --bootstrap-server $${KAFKA_BROKER} --list | grep -q $$topic || 
          (kafka-topics --bootstrap-server $${KAFKA_BROKER} --create --topic $$topic --partitions 1 --replication-factor 1 &&
           echo '   ‚úÖ –°–æ–∑–¥–∞–Ω —Ç–æ–ø–∏–∫: $$topic')
        done &&
        echo 'üéâ Kafka —Ç–æ–ø–∏–∫–∏ –≥–æ—Ç–æ–≤—ã'
      "
    networks:
      - restaurant-network

volumes:
  postgres_auth_data:
  postgres_menu_data:
  postgres_reservation_data:

networks:
  restaurant-network:
    driver: bridge